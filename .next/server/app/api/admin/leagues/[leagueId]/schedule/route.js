(()=>{var a={};a.id=7453,a.ids=[7453],a.modules={261:a=>{"use strict";a.exports=require("next/dist/shared/lib/router/utils/app-paths")},3295:a=>{"use strict";a.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},10846:a=>{"use strict";a.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},11723:a=>{"use strict";a.exports=require("querystring")},12412:a=>{"use strict";a.exports=require("assert")},19121:a=>{"use strict";a.exports=require("next/dist/server/app-render/action-async-storage.external.js")},28354:a=>{"use strict";a.exports=require("util")},29294:a=>{"use strict";a.exports=require("next/dist/server/app-render/work-async-storage.external.js")},44870:a=>{"use strict";a.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},55511:a=>{"use strict";a.exports=require("crypto")},55591:a=>{"use strict";a.exports=require("https")},63033:a=>{"use strict";a.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},66147:(a,b,c)=>{"use strict";c.d(b,{N:()=>h});var d=c(28120),e=c(23168),f=c(70373),g=c(7028);let h={adapter:(0,e.y)(f.z),session:{strategy:"jwt"},pages:{signIn:"/login",signOut:"/",error:"/login"},providers:[(0,d.A)({name:"credentials",credentials:{email:{label:"Email",type:"email"},password:{label:"Password",type:"password"}},async authorize(a){if(!a?.email||!a?.password)return null;let b=await f.z.user.findUnique({where:{email:a.email}});return b&&b.password&&await g.Ay.compare(a.password,b.password)?{id:b.id,email:b.email,name:b.name,isAdmin:b.isAdmin}:null}})],callbacks:{jwt:async({token:a,user:b})=>(b&&(a.id=b.id,a.isAdmin=b.isAdmin),a),session:async({session:a,token:b})=>(b&&(a.user.id=b.id,a.user.isAdmin=b.isAdmin),a)}}},70373:(a,b,c)=>{"use strict";c.d(b,{z:()=>e});var d=c(96330);let e=globalThis.prisma??new d.PrismaClient},74075:a=>{"use strict";a.exports=require("zlib")},78335:()=>{},79428:a=>{"use strict";a.exports=require("buffer")},79551:a=>{"use strict";a.exports=require("url")},81630:a=>{"use strict";a.exports=require("http")},82787:(a,b,c)=>{"use strict";c.r(b),c.d(b,{handler:()=>I,patchFetch:()=>H,routeModule:()=>D,serverHooks:()=>G,workAsyncStorage:()=>E,workUnitAsyncStorage:()=>F});var d={};c.r(d),c.d(d,{DELETE:()=>C,GET:()=>A,POST:()=>B});var e=c(95736),f=c(9117),g=c(4044),h=c(39326),i=c(32324),j=c(261),k=c(54290),l=c(85328),m=c(38928),n=c(46595),o=c(3421),p=c(17679),q=c(41681),r=c(63446),s=c(86439),t=c(51356),u=c(10641),v=c(1093),w=c(66147),x=c(70373);async function y(a,b,c=60){let d=await x.z.globalCourtAvailability.findMany({where:{isActive:!0},orderBy:[{dayOfWeek:"asc"},{startTime:"asc"}]}),e=[],f=new Date(a);for(;f<=b;){let a=f.getDay();for(let b of d.filter(b=>b.dayOfWeek===a)){let[a,d]=b.startTime.split(":").map(Number),[g,h]=b.endTime.split(":").map(Number),i=60*a+d,j=60*g+h,k=a=>5*Math.round(a/5);i=k(i),j=k(j);for(let a=i;a+c<=j;a+=c){let b=a,d=Math.floor(b/60),g=b%60,h=a+c,i=Math.floor(h/60),j=h%60,k=`${d.toString().padStart(2,"0")}:${g.toString().padStart(2,"0")}`,l=`${i.toString().padStart(2,"0")}:${j.toString().padStart(2,"0")}`;e.push({date:new Date(f),courtNumber:1,startTime:k,endTime:l}),e.push({date:new Date(f),courtNumber:2,startTime:k,endTime:l})}}f.setDate(f.getDate()+1)}return e}async function z(a,b=45){let c=await x.z.league.findUnique({where:{id:a},include:{divisions:{include:{registrations:{where:{status:"CONFIRMED"},include:{user:!0}}}}}});if(!c)throw Error("League not found");let d=[],e=[],f=await y(c.startDate,c.endDate,b),g=await x.z.match.findMany({where:{scheduledTime:{gte:c.startDate,lte:c.endDate},status:{not:"CANCELLED"},leagueId:{not:a}},select:{scheduledTime:!0,courtNumber:!0,leagueId:!0}}),h=new Set;g.forEach(a=>{if(a.scheduledTime&&a.courtNumber){let b=`${a.scheduledTime.toISOString()}_court${a.courtNumber}`;h.add(b)}});let i=f.filter(a=>{let b=new Date(a.date),[c,d]=a.startTime.split(":").map(Number);b.setHours(c,d,0,0);let e=`${b.toISOString()}_court${a.courtNumber}`;return!h.has(e)});i.filter(a=>{let b=new Date(a.date),d=new Date(c.startDate),e=new Date(c.startDate);return e.setDate(e.getDate()+7),b>=d&&b<e}).length;let j=0;for(let a of c.divisions){let b=a.registrations.map(b=>({id:b.user.id,name:b.user.name,divisionId:a.id}));if(!(b.length<2))if("CUTTHROAT"===c.gameType){let f=function(a,b){let c=[],d=a.length,e=new Map,f=(a,b)=>[a,b].sort().join("-"),g=a=>{let b=a.map(a=>a.id);return 0+(e.get(f(b[0],b[1]))||0)+(e.get(f(b[0],b[2]))||0)+(e.get(f(b[1],b[2]))||0)};for(let h=0;h<b;h++){let b=[],h=new Set,i=[...a].sort(()=>Math.random()-.5);for(;h.size<d-d%3;){let a=i.filter(a=>!h.has(a.id));if(a.length<3)break;let c=null,d=1/0;for(let b=0;b<10&&a.length>=3;b++){let b=[a[Math.floor(Math.random()*a.length)],a[Math.floor(Math.random()*a.length)],a[Math.floor(Math.random()*a.length)]];if(3!==new Set(b.map(a=>a.id)).size)continue;let h=g(b),i=e.get(f(b[0].id,b[1].id))||0,j=e.get(f(b[0].id,b[2].id))||0,k=e.get(f(b[1].id,b[2].id))||0;i>0&&j>0&&k>0||h<d&&(d=h,c=b)}if(c){b.push(c),c.forEach(a=>h.add(a.id));let a=c.map(a=>a.id);e.set(f(a[0],a[1]),(e.get(f(a[0],a[1]))||0)+1),e.set(f(a[0],a[2]),(e.get(f(a[0],a[2]))||0)+1),e.set(f(a[1],a[2]),(e.get(f(a[1],a[2]))||0)+1)}else{let c=[a[0],a[1],a[2]];b.push(c),c.forEach(a=>h.add(a.id))}}c.push(b)}return c}(b,c.weeksForCutthroat||8);for(let b=0;b<f.length;b++)for(let g of f[b])if(j>=i.length)e.push({player1Id:g[0].id,player2Id:g[1].id,player3Id:g[2].id,courtNumber:1,scheduledTime:new Date(c.endDate),weekNumber:b+1,divisionId:a.id});else{let f=i[j++],k=new Date(f.date),[l,m]=f.startTime.split(":").map(Number);if(k.setHours(l,m,0,0),k>c.endDate){e.push({player1Id:g[0].id,player2Id:g[1].id,player3Id:g[2].id,courtNumber:f.courtNumber,scheduledTime:new Date(c.endDate),weekNumber:b+1,divisionId:a.id});continue}let n=`${k.toISOString()}_court${f.courtNumber}`;h.add(n),d.push({player1Id:g[0].id,player2Id:g[1].id,player3Id:g[2].id,courtNumber:f.courtNumber,scheduledTime:k,weekNumber:b+1,divisionId:a.id})}}else{let f=[...function(a){let b=[],c=[...a];c.length%2!=0&&c.push({id:"bye",name:"Bye"});let d=c.length,e=d-1;for(let a=0;a<e;a++){for(let a=0;a<d/2;a++){let e=c[a],f=c[d-1-a];"bye"!==e.id&&"bye"!==f.id&&b.push([e,f])}c.splice(1,0,c.pop())}return b}(b)].sort(()=>Math.random()-.5),g=Math.floor(b.length/2),j=Math.ceil(f.length/g),k=[];for(let a=0;a<j;a++){let b=[],d=new Date(c.startDate);d.setDate(d.getDate()+7*a);let e=new Date(d);for(let a of(e.setDate(e.getDate()+7),i)){let c=new Date(a.date);c>=d&&c<e&&b.push(a)}k.push(b)}for(let b=0;b<f.length;b++){let[i,j]=f[b],l=Math.floor(b/g)+1,m=[...k[l-1]||[]].sort(()=>Math.random()-.5),n=null,o=!1;for(let a of m){let b=new Date(a.date),[c,e]=a.startTime.split(":").map(Number);b.setHours(c,e,0,0);let f=`${b.toISOString()}_court${a.courtNumber}`,g=h.has(f),i=d.some(c=>c.scheduledTime.getTime()===b.getTime()&&c.courtNumber===a.courtNumber);if(!g&&!i){n=a,o=!0;break}}if(o&&n){let b=new Date(n.date),[f,g]=n.startTime.split(":").map(Number);if(b.setHours(f,g,0,0),b>c.endDate){e.push({player1Id:i.id,player2Id:j.id,courtNumber:n.courtNumber,scheduledTime:new Date(c.endDate),weekNumber:l,divisionId:a.id});continue}let k=`${b.toISOString()}_court${n.courtNumber}`;h.add(k),d.push({player1Id:i.id,player2Id:j.id,courtNumber:n.courtNumber,scheduledTime:b,weekNumber:l,divisionId:a.id})}else e.push({player1Id:i.id,player2Id:j.id,courtNumber:1,scheduledTime:new Date(c.endDate),weekNumber:l,divisionId:a.id})}}}let k=Math.max(...d.map(a=>a.weekNumber),0),l=d.length+e.length;return{scheduledMatches:d,makeupMatches:e,totalWeeks:k,projectedGames:l}}async function A(a,{params:b}){let{leagueId:c}=await b,d=await (0,v.getServerSession)(w.N);if(!d||!d.user.isAdmin)return u.NextResponse.json({error:"Unauthorized"},{status:401});try{let a=await x.z.match.findMany({where:{leagueId:c},include:{player1:!0,player2:!0,player3:!0,player4:!0,court:!0},orderBy:[{weekNumber:"asc"},{scheduledTime:"asc"}]});if(a.length>0)return u.NextResponse.json({matches:a,isGenerated:!0,totalWeeks:Math.max(...a.map(a=>a.weekNumber||0)),totalMatches:a.length,makeupMatches:a.filter(a=>a.isMakeup).length});let b=await x.z.league.findUnique({where:{id:c}});if(!b)return u.NextResponse.json({error:"League not found"},{status:404});let d=await z(c,b.matchDuration),e=new Set;[...d.scheduledMatches,...d.makeupMatches].forEach(a=>{e.add(a.player1Id),e.add(a.player2Id),a.player3Id&&e.add(a.player3Id),a.player4Id&&e.add(a.player4Id)});let f=await x.z.user.findMany({where:{id:{in:Array.from(e)}},select:{id:!0,name:!0,email:!0}}),g=new Map(f.map(a=>[a.id,a])),h=d.scheduledMatches.map(a=>({...a,player1:g.get(a.player1Id),player2:g.get(a.player2Id),player3:a.player3Id?g.get(a.player3Id):void 0,player4:a.player4Id?g.get(a.player4Id):void 0})),i=d.makeupMatches.map(a=>({...a,player1:g.get(a.player1Id),player2:g.get(a.player2Id),player3:a.player3Id?g.get(a.player3Id):void 0,player4:a.player4Id?g.get(a.player4Id):void 0}));return u.NextResponse.json({preview:{...d,scheduledMatches:h,makeupMatches:i},isGenerated:!1})}catch(a){return console.error("Schedule generation error:",a),u.NextResponse.json({error:"Failed to generate schedule"},{status:500})}}async function B(a,{params:b}){let{leagueId:c}=await b,d=await (0,v.getServerSession)(w.N);if(!d||!d.user.isAdmin)return u.NextResponse.json({error:"Unauthorized"},{status:401});try{if(await x.z.match.count({where:{leagueId:c}})>0)return u.NextResponse.json({error:"Schedule already generated for this league"},{status:400});let a=await x.z.league.findUnique({where:{id:c}});if(!a)return u.NextResponse.json({error:"League not found"},{status:404});let{scheduledMatches:b,makeupMatches:d}=await z(c,a.matchDuration),e=await x.z.court.findFirst({where:{number:1}});e||(e=await x.z.court.create({data:{name:"Court 1",number:1,isActive:!0}}));let f=await x.z.court.findFirst({where:{number:2}});f||(f=await x.z.court.create({data:{name:"Court 2",number:2,isActive:!0}}));let g=b.map(a=>({leagueId:c,divisionId:a.divisionId,player1Id:a.player1Id,player2Id:a.player2Id,player3Id:a.player3Id,player4Id:a.player4Id,courtId:1===a.courtNumber?e.id:f.id,courtNumber:a.courtNumber,scheduledTime:a.scheduledTime,weekNumber:a.weekNumber,isMakeup:!1,status:"SCHEDULED"})),h=d.map(a=>({leagueId:c,divisionId:a.divisionId,player1Id:a.player1Id,player2Id:a.player2Id,player3Id:a.player3Id,player4Id:a.player4Id,courtId:null,courtNumber:null,scheduledTime:a.scheduledTime,weekNumber:a.weekNumber,isMakeup:!0,status:"SCHEDULED"}));return await x.z.match.createMany({data:[...g,...h]}),await x.z.league.update({where:{id:c},data:{scheduleGenerated:!0}}),u.NextResponse.json({success:!0,totalMatches:b.length,makeupMatches:d.length,message:`Created ${b.length} scheduled matches and ${d.length} makeup matches`})}catch(a){return console.error("Schedule creation error:",a),u.NextResponse.json({error:"Failed to create schedule"},{status:500})}}async function C(a,{params:b}){let{leagueId:c}=await b,d=await (0,v.getServerSession)(w.N);if(!d||!d.user.isAdmin)return u.NextResponse.json({error:"Unauthorized"},{status:401});try{return await x.z.match.deleteMany({where:{leagueId:c}}),await x.z.league.update({where:{id:c},data:{scheduleGenerated:!1}}),u.NextResponse.json({success:!0})}catch(a){return console.error("Schedule deletion error:",a),u.NextResponse.json({error:"Failed to delete schedule"},{status:500})}}let D=new e.AppRouteRouteModule({definition:{kind:f.RouteKind.APP_ROUTE,page:"/api/admin/leagues/[leagueId]/schedule/route",pathname:"/api/admin/leagues/[leagueId]/schedule",filename:"route",bundlePath:"app/api/admin/leagues/[leagueId]/schedule/route"},distDir:".next",relativeProjectDir:"",resolvedPagePath:"/home/winwi/my-projects/racquetball_website/app/api/admin/leagues/[leagueId]/schedule/route.ts",nextConfigOutput:"",userland:d}),{workAsyncStorage:E,workUnitAsyncStorage:F,serverHooks:G}=D;function H(){return(0,g.patchFetch)({workAsyncStorage:E,workUnitAsyncStorage:F})}async function I(a,b,c){var d;let e="/api/admin/leagues/[leagueId]/schedule/route";"/index"===e&&(e="/");let g=await D.prepare(a,b,{srcPage:e,multiZoneDraftMode:!1});if(!g)return b.statusCode=400,b.end("Bad Request"),null==c.waitUntil||c.waitUntil.call(c,Promise.resolve()),null;let{buildId:u,params:v,nextConfig:w,isDraftMode:x,prerenderManifest:y,routerServerContext:z,isOnDemandRevalidate:A,revalidateOnlyGenerated:B,resolvedPathname:C}=g,E=(0,j.normalizeAppPath)(e),F=!!(y.dynamicRoutes[E]||y.routes[C]);if(F&&!x){let a=!!y.routes[C],b=y.dynamicRoutes[E];if(b&&!1===b.fallback&&!a)throw new s.NoFallbackError}let G=null;!F||D.isDev||x||(G="/index"===(G=C)?"/":G);let H=!0===D.isDev||!F,I=F&&!H,J=a.method||"GET",K=(0,i.getTracer)(),L=K.getActiveScopeSpan(),M={params:v,prerenderManifest:y,renderOpts:{experimental:{cacheComponents:!!w.experimental.cacheComponents,authInterrupts:!!w.experimental.authInterrupts},supportsDynamicResponse:H,incrementalCache:(0,h.getRequestMeta)(a,"incrementalCache"),cacheLifeProfiles:null==(d=w.experimental)?void 0:d.cacheLife,isRevalidate:I,waitUntil:c.waitUntil,onClose:a=>{b.on("close",a)},onAfterTaskError:void 0,onInstrumentationRequestError:(b,c,d)=>D.onRequestError(a,b,d,z)},sharedContext:{buildId:u}},N=new k.NodeNextRequest(a),O=new k.NodeNextResponse(b),P=l.NextRequestAdapter.fromNodeNextRequest(N,(0,l.signalFromNodeResponse)(b));try{let d=async c=>D.handle(P,M).finally(()=>{if(!c)return;c.setAttributes({"http.status_code":b.statusCode,"next.rsc":!1});let d=K.getRootSpanAttributes();if(!d)return;if(d.get("next.span_type")!==m.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${d.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let e=d.get("next.route");if(e){let a=`${J} ${e}`;c.setAttributes({"next.route":e,"http.route":e,"next.span_name":a}),c.updateName(a)}else c.updateName(`${J} ${a.url}`)}),g=async g=>{var i,j;let k=async({previousCacheEntry:f})=>{try{if(!(0,h.getRequestMeta)(a,"minimalMode")&&A&&B&&!f)return b.statusCode=404,b.setHeader("x-nextjs-cache","REVALIDATED"),b.end("This page could not be found"),null;let e=await d(g);a.fetchMetrics=M.renderOpts.fetchMetrics;let i=M.renderOpts.pendingWaitUntil;i&&c.waitUntil&&(c.waitUntil(i),i=void 0);let j=M.renderOpts.collectedTags;if(!F)return await (0,o.I)(N,O,e,M.renderOpts.pendingWaitUntil),null;{let a=await e.blob(),b=(0,p.toNodeOutgoingHttpHeaders)(e.headers);j&&(b[r.NEXT_CACHE_TAGS_HEADER]=j),!b["content-type"]&&a.type&&(b["content-type"]=a.type);let c=void 0!==M.renderOpts.collectedRevalidate&&!(M.renderOpts.collectedRevalidate>=r.INFINITE_CACHE)&&M.renderOpts.collectedRevalidate,d=void 0===M.renderOpts.collectedExpire||M.renderOpts.collectedExpire>=r.INFINITE_CACHE?void 0:M.renderOpts.collectedExpire;return{value:{kind:t.CachedRouteKind.APP_ROUTE,status:e.status,body:Buffer.from(await a.arrayBuffer()),headers:b},cacheControl:{revalidate:c,expire:d}}}}catch(b){throw(null==f?void 0:f.isStale)&&await D.onRequestError(a,b,{routerKind:"App Router",routePath:e,routeType:"route",revalidateReason:(0,n.c)({isRevalidate:I,isOnDemandRevalidate:A})},z),b}},l=await D.handleResponse({req:a,nextConfig:w,cacheKey:G,routeKind:f.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:y,isRoutePPREnabled:!1,isOnDemandRevalidate:A,revalidateOnlyGenerated:B,responseGenerator:k,waitUntil:c.waitUntil});if(!F)return null;if((null==l||null==(i=l.value)?void 0:i.kind)!==t.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==l||null==(j=l.value)?void 0:j.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});(0,h.getRequestMeta)(a,"minimalMode")||b.setHeader("x-nextjs-cache",A?"REVALIDATED":l.isMiss?"MISS":l.isStale?"STALE":"HIT"),x&&b.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let m=(0,p.fromNodeOutgoingHttpHeaders)(l.value.headers);return(0,h.getRequestMeta)(a,"minimalMode")&&F||m.delete(r.NEXT_CACHE_TAGS_HEADER),!l.cacheControl||b.getHeader("Cache-Control")||m.get("Cache-Control")||m.set("Cache-Control",(0,q.getCacheControlHeader)(l.cacheControl)),await (0,o.I)(N,O,new Response(l.value.body,{headers:m,status:l.value.status||200})),null};L?await g(L):await K.withPropagatedContext(a.headers,()=>K.trace(m.BaseServerSpan.handleRequest,{spanName:`${J} ${a.url}`,kind:i.SpanKind.SERVER,attributes:{"http.method":J,"http.target":a.url}},g))}catch(b){if(b instanceof s.NoFallbackError||await D.onRequestError(a,b,{routerKind:"App Router",routePath:E,routeType:"route",revalidateReason:(0,n.c)({isRevalidate:I,isOnDemandRevalidate:A})}),F)throw b;return await (0,o.I)(N,O,new Response(null,{status:500})),null}}},86439:a=>{"use strict";a.exports=require("next/dist/shared/lib/no-fallback-error.external")},94735:a=>{"use strict";a.exports=require("events")},96330:a=>{"use strict";a.exports=require("@prisma/client")},96487:()=>{}};var b=require("../../../../../../webpack-runtime.js");b.C(a);var c=b.X(0,[4996,1692,7028,4419],()=>b(b.s=82787));module.exports=c})();